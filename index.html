<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Avatar ¬∑ Chat IA + 3D</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; }
    #container { display:flex; gap: 32px; align-items: flex-start; justify-content:center; margin:32px auto;}
    #avatar-panel { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #ccc; padding:20px;}
    #avatar-container { width: 400px; height: 400px; }
    #chat-panel { max-width: 500px; background: #fff; border-radius:12px; box-shadow: 0 2px 8px #ccc; padding:20px;}
    #chatbox { min-height:220px; max-width: 500px; }
    .msg { margin: 8px 0; padding: 5px 10px; border-radius: 12px; }
    .user { background: #e2f4ff; text-align: right; }
    .bot { background: #e0e0e0; text-align: left; }
    #chatform { max-width: 500px; margin: 0 auto; display: flex; gap: 8px; }
    #userinput { flex: 1; padding: 6px; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 6px 14px; border-radius: 6px; background: #2196f3; color: #fff; border: none; cursor: pointer; }
    .read-btn { padding: 4px 10px; font-size: 14px; margin-left: 8px; background: #4caf50; }
    .read-btn:hover { background: #45a049; }
    #controls { margin:16px 0 8px 0; display:flex; gap:12px; align-items:center;}
    select { padding:4px 8px; border-radius:6px;}
    label { font-size:14px; color:#444;}
  </style>
  <!-- Three.js & GLTFLoader CDN -->
  <script src="https://unpkg.com/three@0.146.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
<div id="container">
  <div id="avatar-panel">
    <h2>Avatar Eumonia1</h2>
    <div id="avatar-container"></div>
    <div id="controls">
      <label for="langSelect">Langue:</label>
      <select id="langSelect">
        <option value="fr-FR">Fran√ßais</option>
        <option value="en-US">English</option>
        <option value="es-ES">Espa√±ol</option>
      </select>
      <label for="voiceSelect">Voix:</label>
      <select id="voiceSelect"><option>Chargement...</option></select>
    </div>
  </div>
  <div id="chat-panel">
    <div id="chatbox"></div>
    <form id="chatform">
      <input id="userinput" type="text" placeholder="Pose ta question..." autocomplete="off" required />
      <button type="submit">Envoyer</button>
    </form>
  </div>
</div>
<script>
  // ========== AVATAR 3D ==========
  let avatar, mouthMorphIndex = -1, speaking = false;
  
  if (typeof THREE !== 'undefined') {
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 400/400, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ alpha:true });
    renderer.setSize(400, 400);
    document.getElementById('avatar-container').appendChild(renderer.domElement);

    // Charge le mod√®le GLTF
    const loader = new THREE.GLTFLoader();
    loader.load('eunomie (1).glb', function(gltf) {
      avatar = gltf.scene;
      scene.add(avatar);
      camera.position.z = 5;
      // D√©tection auto du morph/blendshape pour la bouche
      avatar.traverse(function(obj) {
        if (obj.isMesh && obj.morphTargetDictionary) {
          // Cherche une morph cible typique de bouche
          for (const k in obj.morphTargetDictionary) {
            if (/mouth|open|viseme|aa|blendshape/i.test(k)) {
              mouthMorphIndex = obj.morphTargetDictionary[k];
              obj.morphTargetInfluences[mouthMorphIndex] = 0;
            }
          }
        }
      });
      animate();
    });

    function animate() {
      requestAnimationFrame(animate);
      if (avatar && speaking && mouthMorphIndex >= 0) {
        // Bouge la bouche (animation simple)
        avatar.traverse(function(obj) {
          if (obj.isMesh && obj.morphTargetInfluences && mouthMorphIndex >= 0) {
            obj.morphTargetInfluences[mouthMorphIndex] = 0.7 * Math.abs(Math.sin(Date.now()/120));
          }
        });
      } else if (avatar && mouthMorphIndex >= 0) {
        avatar.traverse(function(obj) {
          if (obj.isMesh && obj.morphTargetInfluences && mouthMorphIndex >= 0) {
            obj.morphTargetInfluences[mouthMorphIndex] = 0;
          }
        });
      }
      renderer.render(scene, camera);
    }
  }

  // ========== SYNTH√àSE VOCALE MULTILANGUE ==========
  const langSelect = document.getElementById('langSelect');
  const voiceSelect = document.getElementById('voiceSelect');
  let voices = [];
  let currentLang = langSelect.value;
  let currentVoice = null;

  function populateVoices() {
    voices = window.speechSynthesis.getVoices();
    const filtered = voices.filter(v => v.lang === currentLang || v.lang.startsWith(currentLang.split('-')[0]));
    voiceSelect.innerHTML = "";
    filtered.forEach((v,i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = v.name + " ("+v.lang+")";
      voiceSelect.appendChild(opt);
    });
    currentVoice = filtered[0] || null;
    voiceSelect.selectedIndex = 0;
  }
  if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = populateVoices;
    populateVoices();
  }
  langSelect.addEventListener('change', ()=> {
    currentLang = langSelect.value;
    populateVoices();
  });
  voiceSelect.addEventListener('change', ()=> {
    const filtered = voices.filter(v => v.lang === currentLang || v.lang.startsWith(currentLang.split('-')[0]));
    currentVoice = filtered[voiceSelect.selectedIndex] || null;
  });

  function speak(text) {
    if ('speechSynthesis' in window) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = currentLang;
      if (currentVoice) utter.voice = currentVoice;
      utter.onstart = () => { speaking = true; };
      utter.onend = () => { speaking = false; };
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }
  }

  // ========== CHATBOT ==========
  const chatbox = document.getElementById('chatbox');
  function addMsg(text, sender) {
    const div = document.createElement('div');
    div.className = 'msg ' + sender;
    div.textContent = text;
    
    // Add read button for bot messages
    if (sender === 'bot') {
      const readBtn = document.createElement('button');
      readBtn.className = 'read-btn';
      readBtn.textContent = 'üîä Lire la r√©ponse';
      readBtn.onclick = function() {
        speak(text);
      };
      div.appendChild(document.createTextNode(' '));
      div.appendChild(readBtn);
    }
    
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
  }
  async function botReply(msg) {
    addMsg("Attends la r√©ponse de l'IA...", "bot");
    try {
      const response = await fetch("https://english-avator-u31q.vercel.app/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });
      if (!response.ok) {
        throw new Error("API non disponible");
      }
      const data = await response.json();
      let reply = data.reply || data.answer || data.message || "R√©ponse IA re√ßue, mais format inattendu.";
      return reply;
    } catch (e) {
      return "‚ùå Erreur API‚ÄØ: Impossible d‚Äôobtenir la r√©ponse IA.";
    }
  }
  document.getElementById('chatform').onsubmit = async function(e) {
    e.preventDefault();
    const usermsg = document.getElementById('userinput').value;
    addMsg(usermsg, 'user');
    const reply = await botReply(usermsg);
    addMsg(reply, 'bot');
    speak(reply);
    document.getElementById('userinput').value = '';
  };
  // Message d‚Äôaccueil
  addMsg("Bienvenue‚ÄØ! Je suis ton avatar intelligent. Pose-moi une question‚ÄØ!", 'bot');
</script>
</body>
</html>