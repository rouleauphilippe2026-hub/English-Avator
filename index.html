<script>
async function sendMessage() {
  const input = document.getElementById("userInput");
  const message = input.value.trim();
  if (!message) return;

  const chatBox = document.getElementById("chat");
  chatBox.innerHTML += `<p><b>üë§ Toi :</b> ${message}</p>`;
  input.value = "";

  chatBox.innerHTML += `<p><i>‚è≥ Attends la r√©ponse de l'IA...</i></p>`;

  const language = document.getElementById("language").value || "fran√ßais";

  try {
    const response = await fetch("https://english-avator-u31q.vercel.app/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, language })
    });

    const data = await response.json();
    const reply = data.reply || "‚ùå Erreur IA";

    chatBox.innerHTML += `<p><b>ü§ñ Eumonia :</b> ${reply}</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    // --- Lecture vocale automatique ---
    speakText(reply, language);
  } catch (error) {
    chatBox.innerHTML += `<p style="color:red;">‚ùå Erreur API : Impossible d‚Äôobtenir la r√©ponse IA.</p>`;
    console.error("Erreur API:", error);
  }
}

function speakText(text, language) {
  if (!window.speechSynthesis) {
    alert("La synth√®se vocale n'est pas support√©e sur ce navigateur.");
    return;
  }

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = (language === "Fran√ßais") ? "fr-CA" : "en-US";
  utterance.pitch = 1;
  utterance.rate = 1;

  // --- Synchronisation bouche Eumonia1 ---
  const model = window.eumoniaModel;
  if (model && model.morphTargetInfluences) {
    utterance.onstart = () => animateMouth(model, true);
    utterance.onend = () => animateMouth(model, false);
  }

  speechSynthesis.speak(utterance);
}

function animateMouth(model, speaking) {
  let interval;
  if (speaking) {
    interval = setInterval(() => {
      model.morphTargetInfluences[0] = Math.random() * 0.8; // animation bouche
    }, 90);
    window.mouthInterval = interval;
  } else {
    clearInterval(window.mouthInterval);
    model.morphTargetInfluences[0] = 0; // bouche ferm√©e
  }
}

// --- Gestion touche Entr√©e ---
document.getElementById("userInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});
</script>
